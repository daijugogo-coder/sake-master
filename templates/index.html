<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sake Master</title>

  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
  <meta name="theme-color" content="#0f1115">

  <style>
    /* ---- Modal ---- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal {
      width: min(520px, 92vw);
      border-radius: 14px;
      padding: 18px 16px;
      background: rgba(24, 24, 28, 0.96);
      border: 1px solid rgba(255, 255, 255, .10);
      box-shadow: 0 20px 60px rgba(0, 0, 0, .45);
    }

    .spinner {
      margin-top: 12px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, .25);
      border-top-color: rgba(255, 255, 255, .85);
      animation: spin .9s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .header-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 6px;
    }

    .linkbtn {
      background: none;
      border: none;
      padding: 4px 0;
      font-size: 13px;
      text-decoration: underline;
      cursor: pointer;
      opacity: .85;
    }

    label.btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <main class="wrap">
    <header class="header">
      <h1>Sake Master</h1>
      <p class="sub">マスターと会話しながら、お酒の特徴と合わせ方を見つけます。</p>

      <div class="header-actions">
        <button type="button" class="linkbtn" id="resetChatBtn">
          会話を最初からやり直す
        </button>
      </div>
    </header>

    <section class="chat" id="chat">
      <div class="msg master">
        <div class="name">マスター</div>
        <div class="bubble">{{ welcome }}</div>
      </div>
    </section>

    <section class="panel">
      <form id="analyzeForm" class="form">

        <!-- 画像 -->
        <label class="label">
          商品のバーコード画像、もしくは成分表（原材料、度数など）、商品名の写る写真を送ってください。
          <span class="filehint pc-only">PCの場合は複数の画像を一度に送ってください（最大3枚）</span>

          <input
            type="file"
            name="photos"
            id="photos"
            accept="image/*"
            capture="environment"
            multiple
            hidden
          />

          <span class="btn">画像撮影・選択</span>
        </label>

        <div class="filehint" id="fileHint">未選択</div>

        <!-- テキスト -->
        <label class="label">
          お客様からのメッセージ
          <input
            class="text"
            type="text"
            name="customer_text"
            id="customer_text"
            placeholder="例：辛口が好き。今日は魚。すっきりしたい。"
          />
        </label>

        <button class="btn" id="submitBtn" type="submit" disabled>
          伝える
        </button>

      </form>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal">
      <p id="modalTitle">確認中</p>
      <p id="modalSub">写真とメッセージを読み取っています。</p>
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const photosEl = document.getElementById("photos");
    const customerTextEl = document.getElementById("customer_text");
    const fileHintEl = document.getElementById("fileHint");
    const submitBtn = document.getElementById("submitBtn");
    const resetChatBtn = document.getElementById("resetChatBtn");

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) photosEl.removeAttribute("multiple");

    function updateFileUI() {
      const n = photosEl.files.length;
      const hasText = customerTextEl.value.trim().length > 0;
      fileHintEl.textContent = n ? `${n}枚選択` : "未選択";
      submitBtn.disabled = !(n || hasText);
    }

    photosEl.addEventListener("change", updateFileUI);
    customerTextEl.addEventListener("input", updateFileUI);

    resetChatBtn.addEventListener("click", () => {
      if (!confirm("会話を最初からやり直します。よろしいですか？")) return;
      chat.innerHTML = `
        <div class="msg master">
          <div class="name">マスター</div>
          <div class="bubble">{{ welcome }}</div>
        </div>
      `;
      customerTextEl.value = "";
      photosEl.value = "";
      updateFileUI();
    });

    updateFileUI();
  </script>
</body>
</html>
